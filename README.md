# TSBS Analytics 评分系统与聚合计算说明

## 一、项目概述

TSBS Analytics 是一个用于时间序列基准测试（TSBS）结果的自动评分、聚合和可视化系统。该系统通过对比实际测试数据与基准值，计算性能得分，支持多组数据的聚合统计，并提供 Web 接口进行数据查看和分析。

主要功能：
- 数据加载和过滤
- 分组聚合统计
- 性能评分计算
- Web 前端展示（表格、图表）
- API 接口支持

## 二、安装与设置

### 2.1 环境要求
- Python 3.8+
- Flask
- Pandas
- NumPy
- 其他依赖：见 requirements.txt（如果不存在，可根据 app.py 生成）

### 2.2 安装步骤
1. 克隆仓库：
   ```
   git clone <repository_url>
   cd tsbs_analytics
   ```

2. 创建虚拟环境并安装依赖：
   ```
   python -m venv venv
   source venv/bin/activate
   pip install flask pandas numpy
   ```

3. 配置基准值文件（位于 config/ 目录）：
   - master_config.json：主基准配置
   - enterprise_config.json：企业版基准
   - opensource_config.json：开源版基准
   - master_secondary_config.json：次基准配置

4. 运行应用：
   ```
   python app.py
   ```
   访问 http://localhost:5000

## 三、评分体系原理

本系统用于对时间序列基准测试结果进行自动评分和对比，核心思想是：
- 通过对比“实际测试数据”与“基准值”之间的偏差，量化性能一致性。
- 采用加权复合评分，兼顾中心趋势和离散程度。

### 3.1 评分维度与权重
- **中心趋势（70%）**
  - 均值（50%）
  - 中位数（20%）
- **离散程度（30%）**
  - 标准差（20%）
  - 极差（10%）

### 3.2 单项评分公式
对于每个维度，计算偏差率：

    偏差率 = |实际值 - 基准值| / 基准值 × 100%

得分规则：
- 偏差率 ≤ 10%：得100分
- 偏差率 > 10%：得分 = 100 - (偏差率 - 10) × 10
- 得分最低为0分

### 3.3 综合评分公式

    综合得分 = 均值得分 × 0.5 + 中位数得分 × 0.2 + 标准差得分 × 0.2 + 极差得分 × 0.1

注意：如果某些指标缺失，系统会动态调整权重，并使用可用数据的估计值。

## 四、聚合统计流程与算法

实际测试中，同一配置下可能有多组性能数据。为保证评分准确，聚合流程如下：

### 4.1 分组维度
- 分支（branch）
- 规模（scale）
- 集群（cluster）
- 工作线程（worker）
- 执行类型（phase）
- 查询类型（query_type）

### 4.2 聚合算法
- **均值**：所有测试的均值取平均
- **中位数**：所有测试的中位数取中位数（更稳健）
- **标准差**：
  - 若有多组标准差，先取平均，再与均值间的变异（组间标准差）取较大值，最后不超过最大标准差
  - 公式：`聚合标准差 = min(max(平均标准差, 均值间标准差), 最大标准差)`
- **极差**：所有测试的最小值和最大值之差

> 注：如果缺少某项数据，则用可用数据的合理估算（如用均值代替中位数等）

## 五、90分下限处理逻辑

- 系统不再强制将综合得分提升到90分。
- 若综合得分低于90分，前端会显示实际分数，并用“✗”标记为“不通过”。
- 评分结果结构中包含`is_passed`字段，便于前端和接口判断。

## 六、评分显示模式下的源数据展示

在评分显示模式下，系统会显示用于计算评分的源数据，帮助用户理解评分的依据：

### 6.1 功能特点
- **评分与源数据并列显示**：每个评分列旁边都有对应的源数据列
- **详细信息提示**：鼠标悬停在源数据上可查看完整的统计信息
- **基准值对比**：源数据中包含与基准值的对比百分比
- **多维度数据**：显示均值、中位数、标准差、极差等统计指标

### 6.2 导入速度源数据
- 显示实际测量的导入速度值（rows/sec）
- 提示框中包含与基准值的对比百分比
- 格式：`实际值 rows/sec` （悬停查看详情）

### 6.3 查询类型源数据
- 主要显示查询的均值延迟（ms）
- 提示框中包含完整的统计信息：
  - 均值（mean_ms）
  - 中位数（med_ms）
  - 标准差（std_ms）
  - 极差（range_ms）
  - 与基准值的对比百分比
- 格式：`均值ms (详情)` （悬停查看完整统计）

### 6.4 使用方法
1. 在主界面选择"评分显示"模式
2. 选择支持评分的基准值类型（Master第二基准值、企业发版基准值、开源发版基准值）
3. 应用筛选条件查看数据
4. 在结果表格中，每个评分列旁边都有对应的源数据列
5. 鼠标悬停在源数据上可查看详细信息

## 七、典型数据流与接口说明

### 7.1 数据流
1. **数据采集**：采集多组性能测试结果，存储为DataFrame
2. **分组聚合**：按配置分组，调用`calculate_grouped_statistics`进行聚合
3. **评分计算**：对每组聚合结果与基准值进行评分，调用`calculate_comprehensive_score`
4. **前端展示**：前端根据评分和`is_passed`状态渲染表格和标记

### 7.2 主要函数/接口
- `calculate_grouped_statistics(df)`：分组并聚合统计
- `calculate_improved_aggregation(group_df)`：单组聚合算法
- `calculate_aggregated_std(mean_values, std_values)`：聚合标准差算法
- `calculate_comprehensive_score(actual_metrics, baseline_metrics)`：评分主函数
- `/api/test-scoring`：评分API接口，支持前后端联调和自动化测试

### 7.3 评分API返回结构示例
```json
{
  "score_info": {
    "comprehensive_score": 87.5,
    "is_passed": false,
    "detail_scores": {
      "mean_score": 90,
      "median_score": 85,
      "std_score": 80,
      "range_score": 95
    },
    "deviation_rates": {
      "mean_deviation": 11.1,
      "median_deviation": 15.0,
      "std_deviation": 20.0,
      "range_deviation": 5.0
    }
  }
}
```

## 八、使用示例

### 8.1 聚合计算示例

假设有三组测试数据（同一查询类型）：

| 测试 | mean_ms | med_ms | std_ms | min_ms | max_ms |
|------|---------|--------|--------|--------|--------|
| 1    | 50.0   | 45.0  | 10.0  | 30.0  | 70.0  |
| 2    | 52.0   | 47.0  | 12.0  | 35.0  | 75.0  |
| 3    | 48.0   | 43.0  | 8.0   | 25.0  | 65.0  |

聚合结果：
- mean_ms: (50+52+48)/3 = 50.0
- med_ms: 中位数 of [45,47,43] = 45.0
- std_ms: 聚合标准差 ≈ 10.0 (基于平均std=10, 均值std≈2, 取max后min with max_std=12)
- range_ms: max_max - min_min = 75 - 25 = 50.0

### 8.2 评分计算示例

假设基准值：mean=48, median=44, std=9.5, range=38

实际聚合值：mean=50, median=45, std=10, range=50

偏差率：
- mean: |50-48|/48 ≈ 4.17% → 100分
- median: |45-44|/44 ≈ 2.27% → 100分
- std: |10-9.5|/9.5 ≈ 5.26% → 100分
- range: |50-38|/38 ≈ 31.58% → 100 - (31.58-10)*10 ≈ -115.8 → 0分

综合得分：100*0.5 + 100*0.2 + 100*0.2 + 0*0.1 = 90分

is_passed: True (≥90)

### 8.3 API 使用示例

使用 curl 测试评分 API：

```
curl -X POST http://localhost:5001/api/test-scoring \
     -H "Content-Type: application/json" \
     -d '{
           "actual_mean": 50.0,
           "actual_median": 45.0,
           "actual_std": 10.0,
           "actual_range": 40.0,
           "baseline_mean": 50.0,
           "baseline_median": 45.0,
           "baseline_std": 10.0,
           "baseline_range": 40.0
         }'
```

预期返回：综合得分 100 分

### 8.4 特定场景聚合示例：master 分支、prepare 阶段、集群1、工作线程8

以下示例基于 master_secondary_config.json 中的基准数据，假设对于 scale=100 的 'cpu-max-all-1' 查询类型，有三组测试数据（实际系统中可能从日志加载）。我们将展示如何聚合这些数据。

假设测试数据：

| 测试 | mean_ms | med_ms | std_ms | range_ms |
|------|---------|--------|--------|----------|
| 1    | 6.80    | 4.69   | 6.08   | 53.16    |
| 2    | 6.50    | 4.50   | 5.90   | 50.00    |
| 3    | 7.00    | 4.90   | 6.20   | 55.00    |

聚合计算：
- mean_ms: (6.80 + 6.50 + 7.00)/3 ≈ 6.77
- med_ms: 中位数 of [4.69, 4.50, 4.90] = 4.69
- std_ms: 聚合标准差 = min(max(平均std=6.06, 均值间std≈0.25), max_std=6.20) ≈ 6.06
- range_ms: max(range)=55.00 - min(range)=50.00 的调整，但实际使用所有 min/max 差的最大极差假设为 55.00

对于其他 scale 和查询类型，聚合类似。实际基准值如 scale=100 的 'cpu-max-all-1' mean_ms=6.80 可用于对比聚合结果。

## 九、注意事项
- 聚合算法在缺少原始样本数时采用保守估计，实际精度依赖于数据完整性
- 评分体系可根据实际业务需求灵活调整权重和阈值
- 前端和导出功能均已适配评分与通过状态的展示

---
如需进一步了解实现细节，请查阅`app.py`中的相关函数实现，以及测试文件如`test_scoring.py`。
